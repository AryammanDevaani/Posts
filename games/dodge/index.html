<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="icon" type="image/png" href="../../favicon.png">
    <title>DODGE?</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #0a0a0a;
            font-family: monospace;
            color: #e8b0ba;
            user-select: none;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: none;
            border-radius: 20px;
            border: 2px solid #e8b0ba33;
            background: #1a0f0f;
            max-width: 100%;
            height: auto;
        }

        .ui-screen {
            position: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: opacity 0.3s ease;
        }

        .game-title {
            font-family: 'Impact', sans-serif;
            font-size: 4rem;
            letter-spacing: 1px;
            text-shadow: 0 0 15px #e8b0ba33;
            margin-bottom: 30px;
        }

        .button {
            padding: 12px 30px;
            background: #e8b0ba15;
            border: 1px solid #e8b0ba33;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 180px;
            text-align: center;
            font-size: 0.9rem;
        }

        .button:hover {
            background: #e8b0ba25;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px #e8b0ba15;
        }

        .rules-panel {
            position: absolute;
            padding: 20px;
            background: #0a0a0aee;
            border: 1px solid #e8b0ba33;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            max-width: 280px;
            display: none;
            z-index: 100;
            text-align: center;
        }

        .rules-panel.centered {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .rules-list {
            list-style: none;
            padding: 0;
            margin: 10;
            display: inline-block;
            text-align: left;
        }

        .blurred::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(5px);
            z-index: 99;
        }

        .rules-panel-header {
            position: relative;
            margin-bottom: 10px;
        }

        .rules-close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #0a0a0aee;
            border: 1px solid #0a0a0aee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
            font-family: monospace;
            color: #e8b0ba;
        }

        .rules-close-btn:hover {
            transform: translateY(-1px);
        }

        .score-display {
            position: fixed;
            top: 15px;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            display: none;
        }

        .close-game-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #e8b0ba15;
            border: 1px solid #e8b0ba33;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
            font-family: monospace;
            color: #e8b0ba;
            display: none;
        }

        .quit-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 10px 20px;
            background: #e8b0ba15;
            border: 1px solid #e8b0ba33;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
            font-family: monospace;
            color: #e8b0ba;
            display: none;
        }

        .rules-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #e8b0ba15;
            border: 1px solid #e8b0ba33;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
            font-family: monospace;
            color: #e8b0ba;
            display: none;
        }

        .close-game-btn:hover,
        .quit-btn:hover,
        .rules-btn:hover {
            background: #e8b0ba25;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px #e8b0ba15;
        }

        .best-score {
            display: none;
        }
    </style>
</head>

<body>
    <button class="close-game-btn">⏸</button>
    <button class="quit-btn">quit</button>
    <button class="rules-btn">rules</button>

    <div class="ui-screen" id="startScreen">
        <div class="game-title">DODGE?</div>
        <div class="button" id="rulesButton">rules</div>
        <div class="button" id="startButton">start game</div>
        <div class="best-score" id="bestScoreDisplay">best: <span id="bestScoreValue">0</span></div>
    </div>

    <div class="score-display" id="scoreDisplay">
        score: <span id="currentScore">0</span>
    </div>

    <div class="rules-panel" id="rulesPanel">
        <div class="rules-panel-header">
            <button class="rules-close-btn">✕</button>
        </div>
        <ul class="rules-list">
            <li>• left-click to shoot, of course</li>
            <li>• move with A/← or D/→ keys</li>
            <li>• destroy an orb: +1</li>
            <li>• survive an orb: +3</li>
            <li>• miss a bullet: -1</li>
            <li>• collision ends the game</li>
            <li>• score the lowest score possible</li>
        </ul>
    </div>

    <canvas id="game" width="400" height="600"></canvas>

    <audio id="shootSound" src="audio/shoot.wav"></audio>
    <audio id="hitSound" src="audio/hit.wav"></audio>
    <audio id="surviveSound" src="audio/survive.wav"></audio>
    <audio id="missSound" src="audio/miss.wav"></audio>
    <audio id="gameOverSound" src="audio/gameover.wav"></audio>
    <audio id="buttonClick" src="audio/click.wav"></audio>
    <audio id="bgMusic">
        <source src="audio/bgmusic.mp3" type="audio/mpeg">
        <source src="audio/bgmusic.ogg" type="audio/ogg">
    </audio>

    <script>
        let score = 0;
        let gameRunning = false;
        let bestScore = 0;
        let isPaused = false;
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const BULLET_SPEED = 12;
        let texts = [];

        const sounds = {
            shoot: document.getElementById('shootSound'),
            hit: document.getElementById('hitSound'),
            survive: document.getElementById('surviveSound'),
            miss: document.getElementById('missSound'),
            gameOver: document.getElementById('gameOverSound'),
            button: document.getElementById('buttonClick'),
            bgMusic: document.getElementById('bgMusic')
        };

        sounds.shoot.volume = 0.75;
        sounds.hit.volume = 0.75;
        sounds.survive.volume = 0.75;
        sounds.miss.volume = 0.75;
        sounds.gameOver.volume = 0.95;
        sounds.button.volume = 0.75;
        sounds.bgMusic.volume = 0.075;
        sounds.bgMusic.loop = true;

        const player = {
            x: canvas.width / 2 - 20,
            y: canvas.height - 60,
            width: 35,
            height: 35,
            speed: 5
        };

        let obstacles = [];
        let bullets = [];
        let obstacleSpeed = 2.5;
        let spawnInterval = 1300;
        let lastSpawn = 0;
        let lastTime = 0;
        let keys = { left: false, right: false };

        document.getElementById('bestScoreValue').textContent = bestScore;
        document.getElementById('currentScore').textContent = '0';
        document.getElementById('scoreDisplay').style.display = 'none';
        document.getElementById('bestScoreDisplay').style.display = 'none';

        async function unlockAudio() {
            try {
                await Promise.all(Object.values(sounds).map(sound => {
                    return sound.play().then(() => sound.pause());
                }));
            } catch (e) {
                console.log('Audio initialization completed');
            }
        }

        function handleButtonClick() {
            sounds.button.currentTime = 0;
            sounds.button.play().catch(e => console.log('Button click error:', e));
        }

        function handleButtonAction() {
            handleButtonClick();
            if (gameRunning) {
                if (isPaused) resumeGame();
                else pauseGame();
            }
        }

        function toggleRules() {
            handleButtonClick();
            const rulesPanel = document.getElementById('rulesPanel');
            const rulesBtn = document.querySelector('.rules-btn');
            if (rulesPanel.style.display === 'block') {
                closeRules();
            } else {
                rulesPanel.style.display = 'block';
                if (gameRunning) {
                    rulesPanel.classList.remove('centered');
                    rulesPanel.style.top = `${rulesBtn.offsetTop + rulesBtn.offsetHeight + 10}px`;
                    rulesPanel.style.left = `${rulesBtn.offsetLeft}px`;
                } else {
                    rulesPanel.classList.add('centered');
                    rulesPanel.style.top = '';
                    rulesPanel.style.left = '';
                }
                document.body.classList.add('blurred');
            }
        }

        function quitGame() {
            handleButtonClick();
            gameRunning = false;
            isPaused = false;
            score = 0;
            obstacles = [];
            bullets = [];
            texts = [];
            sounds.bgMusic.pause();
            sounds.bgMusic.currentTime = 0;

            document.querySelector('.close-game-btn').style.display = 'none';
            document.querySelector('.rules-btn').style.display = 'none';
            document.querySelector('.quit-btn').style.display = 'none';
            canvas.style.display = 'none';
            document.getElementById('scoreDisplay').style.display = 'none';

            document.getElementById('startScreen').style.opacity = '1';
            document.getElementById('startScreen').style.pointerEvents = 'auto';
            document.getElementById('startButton').textContent = 'restart game';
            document.getElementById('bestScoreDisplay').style.display = 'block';

            player.x = canvas.width / 2 - 20;
            obstacleSpeed = 2.5;
            spawnInterval = 1300;

            closeRules();
        }

        function closeRules() {
            document.getElementById('rulesPanel').style.display = 'none';
            document.body.classList.remove('blurred');
        }

        function closeGame() {
            if (window.parent !== window) {
                window.parent.document.getElementById('gameContainer').style.display = 'none';
                window.parent.document.getElementById('gameFrame').src = '';
                window.parent.document.body.style.overflow = 'auto';
            } else {
                showEndScreen();
            }
        }

        function pauseGame() {
            isPaused = true;
            document.querySelector('.close-game-btn').textContent = '▶';
            document.querySelector('.rules-btn').style.display = 'block';
            document.querySelector('.quit-btn').style.display = 'block';
            sounds.bgMusic.pause();
        }

        function resumeGame() {
            isPaused = false;
            closeRules();
            document.querySelector('.close-game-btn').textContent = '⏸';
            document.querySelector('.rules-btn').style.display = 'none';
            document.querySelector('.quit-btn').style.display = 'none';
            if (gameRunning) {
                sounds.bgMusic.play();
                lastTime = performance.now();
                requestAnimationFrame(gameLoop);
            }
        }

        function startGame() {
            handleButtonClick();
            isPaused = false;
            document.querySelector('.close-game-btn').style.display = 'block';
            document.querySelector('.close-game-btn').textContent = '⏸';
            document.querySelector('.rules-btn').style.display = 'none';
            document.querySelector('.quit-btn').style.display = 'none';
            document.getElementById('rulesButton').style.display = 'none';
            document.getElementById('bestScoreDisplay').style.display = 'none';
            document.getElementById('startScreen').style.opacity = '0';
            document.getElementById('startScreen').style.pointerEvents = 'none';
            canvas.style.display = 'block';
            document.getElementById('scoreDisplay').style.display = 'block';
            closeRules();
            gameRunning = true;
            resetGame();

            sounds.bgMusic.currentTime = 0;
            sounds.bgMusic.play().catch(e => {
                document.body.addEventListener('click', () => {
                    sounds.bgMusic.play();
                }, { once: true });
            });

            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function showEndScreen() {
            if (!gameRunning) return;

            gameRunning = false;
            isPaused = false;
            document.querySelector('.close-game-btn').style.display = 'none';
            document.querySelector('.rules-btn').style.display = 'none';
            document.querySelector('.quit-btn').style.display = 'none';
            canvas.style.display = 'none';
            document.getElementById('scoreDisplay').style.display = 'none';
            document.getElementById('startScreen').style.opacity = '1';
            document.getElementById('startScreen').style.pointerEvents = 'auto';
            document.getElementById('startButton').textContent = 'restart game';
            document.getElementById('bestScoreDisplay').style.display = 'block';
            sounds.bgMusic.pause();
            sounds.bgMusic.currentTime = 0;
            sounds.gameOver.play();
            closeRules();

            if ((score < bestScore || bestScore === 0) && score !== 0) {
                bestScore = score;
                document.getElementById('bestScoreValue').textContent = bestScore;
            }
        }

        function resetGame() {
            score = 0;
            obstacles = [];
            bullets = [];
            texts = [];
            obstacleSpeed = 2.5;
            spawnInterval = 1300;
            player.x = canvas.width / 2 - 20;
            keys = { left: false, right: false };
            updateScoreDisplay();
        }

        function updateScoreDisplay() {
            document.getElementById('currentScore').textContent = score;
        }

        function pushText(x, y, str, className) {
            texts.push({ x, y, str, className, lifetime: 1000, age: 0, vy: -0.1 });
        }

        function drawTexts(dt) {
            texts.forEach((text, index) => {
                text.age += dt;
                text.y += text.vy * dt;
                const alpha = 1 - (text.age / text.lifetime);
                ctx.fillStyle = text.className === 'score-add' ? '#FF3366' : '#FFD700';
                ctx.globalAlpha = alpha;
                ctx.font = 'bold 18px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(text.str, text.x, text.y);
                if (text.age >= text.lifetime) texts.splice(index, 1);
            });
            ctx.globalAlpha = 1;
        }

        function spawnObstacle() {
            const types = ['small', 'medium', 'large'];
            const type = types[Math.floor(Math.random() * 3)];
            const radius = { small: 10, medium: 15, large: 20 }[type];
            const x = radius + Math.random() * (canvas.width - radius * 2);
            obstacles.push({
                x, y: -radius,
                radius,
                type,
                hits: { small: 1, medium: 2, large: 3 }[type],
                vx: (Math.random() - 0.5) * 1.2,
                oldRadius: radius,
                newRadius: radius,
                animProgress: 1,
                animDuration: 200
            });
        }

        function gameLoop(timestamp) {
            if (!gameRunning || isPaused) return;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            if (keys.left) {
                player.x -= player.speed * (deltaTime / 16);
            }
            if (keys.right) {
                player.x += player.speed * (deltaTime / 16);
            }
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

            if (timestamp - lastSpawn > spawnInterval) {
                spawnObstacle();
                lastSpawn = timestamp;
            }

            updateObstacles(deltaTime);
            updateBullets(deltaTime);
            checkCollisions();
            increaseDifficulty(deltaTime);

            ctx.fillStyle = '#1a0f0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#e8b0ba';
            ctx.fillRect(player.x, player.y, player.width, player.height);

            ctx.fillStyle = '#ff6b6b';
            obstacles.forEach(o => {
                ctx.beginPath();
                ctx.arc(o.x, o.y, o.radius, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.fillStyle = '#4fc3f7';
            bullets.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });

            drawTexts(deltaTime);
            requestAnimationFrame(gameLoop);
        }

        function updateObstacles(dt) {
            obstacles.forEach((o, index) => {
                if (o.animProgress < 1) {
                    o.animProgress += dt / o.animDuration;
                    o.radius = o.oldRadius + (o.newRadius - o.oldRadius) * o.animProgress;
                }

                const trackStrength = 0.006;
                o.vx += (player.x - o.x) * trackStrength * (dt / 16);
                o.vx = Math.max(-1.5, Math.min(1.5, o.vx));

                o.y += obstacleSpeed * (dt / 16);
                o.x += o.vx * (dt / 16);
                o.x = Math.max(o.radius, Math.min(canvas.width - o.radius, o.x));

                if (o.y - o.radius > canvas.height) {
                    pushText(o.x, canvas.height - 30, '+3', 'score-add');
                    score += 3;
                    obstacles.splice(index, 1);
                    sounds.survive.play();
                    updateScoreDisplay();
                }
            });
        }

        function updateBullets(dt) {
            bullets.forEach((b, index) => {
                b.y -= BULLET_SPEED * (dt / 16);
                obstacles.forEach((o, oIndex) => {
                    const dx = b.x - o.x;
                    const dy = b.y - o.y;
                    if (Math.sqrt(dx * dx + dy * dy) < o.radius + 5) {
                        o.hits--;
                        if (o.hits <= 0) {
                            obstacles.splice(oIndex, 1);
                            pushText(o.x, o.y, '+1', 'score-add');
                            score += 1;
                            sounds.hit.play();
                        } else {
                            o.oldRadius = o.radius;
                            o.newRadius = { large: 15, medium: 10, small: 10 }[o.type];
                            o.animProgress = 0;
                            o.type = { large: 'medium', medium: 'small', small: 'small' }[o.type];
                            sounds.hit.play();
                        }
                        bullets.splice(index, 1);
                        updateScoreDisplay();
                    }
                });
                if (b.y < -10) {
                    pushText(b.x, 20, '-1', 'score-deduct');
                    score--;
                    bullets.splice(index, 1);
                    sounds.miss.play();
                    updateScoreDisplay();
                }
            });
        }

        function increaseDifficulty(dt) {
            obstacleSpeed += 0.0009 * dt;
            spawnInterval = Math.max(700, spawnInterval - 0.25 * dt);
        }

        function checkCollisions() {
            obstacles.forEach(o => {
                const dx = o.x - (player.x + player.width / 2);
                const dy = o.y - (player.y + player.height / 2);
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < o.radius + player.width / 2) {
                    showEndScreen();
                }
            });
        }

        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', handleButtonClick);
        });

        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('rulesButton').addEventListener('click', toggleRules);
        document.querySelector('.close-game-btn').addEventListener('click', handleButtonAction);
        document.querySelector('.quit-btn').addEventListener('click', quitGame);
        document.querySelector('.rules-btn').addEventListener('click', toggleRules);
        document.querySelector('.rules-close-btn').addEventListener('click', closeRules);

        document.addEventListener('keydown', e => {
            if (gameRunning && !isPaused) {
                if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') {
                    keys.left = true;
                }
                if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') {
                    keys.right = true;
                }
            }
        });

        document.addEventListener('keyup', e => {
            if (gameRunning && !isPaused) {
                if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') {
                    keys.left = false;
                }
                if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') {
                    keys.right = false;
                }
            }
        });

        canvas.addEventListener('click', e => {
            if (gameRunning && !isPaused) {
                bullets.push({
                    x: player.x + player.width / 2,
                    y: player.y,
                });
                sounds.shoot.play();
            }
        });

        unlockAudio();
    </script>
</body>

</html>